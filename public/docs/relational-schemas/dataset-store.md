# Schema Store

Sometimes the value of a specific field needs knowledge of data generated by other modules. To solve this problem, the functions executed in the [custom fields](/fields-type/custom) and the [ref fields](/fields-type/ref) receive a store in which information from the entire dataset can be accessed.<br/>
Continuing with the case of users and article posts. You can define in the user schema a field `countPosts` that contains an integer that indicates the number of posts created by the user.

```js
const userSchema = chaca.schema({
  countPosts: ({ store, currentFields: userFields }) => {
    // get all posts belonging to this user
    // returns an array with all the ids of the user's posts
    const allUserPostId = store.getValue("Post.id", {
      where: (postFields) => {
        return postFields.userId === userFields.id
      },
    })

    return allUserPostId.length
  },
})
```

<Danger title="Not work in simple schema generation">
The store only works in [generation of multiple modules](/relational-modules/multi-generate)
</Danger>

## `getValue`

If you want to obtain an array of values belonging to a specific external schema, you must define it with the following pattern. `store.getValue('Schema.[...fields]')`

```js
const schema = chaca.schema({
  field1: chaca.schema({
    field2: modules.id.uuid(),
  }),
})

store.getValue("Schema.field1") // [{ field1: 'value1' }, { field1: 'value2' }, ...]
store.getValue("Schema.field1.field2") // ['value1', 'value2', ...]
```

<Tip title="You can access all external schema objects">
If you pass only the name of the schema, it will return an array with all the objects created from the schema.

```js
store.getValue("Schema") // objects array
```

</Tip>

### Configuration

To configure the obtaining of data from an external schema, an object with the following parameters can be passed as the second parameter of the `getValue` function.

| Param |   Type   | Required | Description                                                                                                  |
| :---: | :------: | :------: | :----------------------------------------------------------------------------------------------------------- |
| where | function |    no    | A function that should return a boolean indicating whether the schema document meets the required conditions |

### ‚ùå Be careful with cyclic errors

It is important to clarify that when wanting to access a field of an external schema through the store, a dependency is created on that selected schema, therefore the creation of the current schema is stopped to start building the data of the other one.<br/>
Then, trying to access one of the modules that make it up should be avoided in that dependency chain.<br/>
Now a case will be presented where this dependency is broken creating a cyclical error.

```js
const userSchema = chaca.schema({
  countPosts: ({ store, currentFields: userFields }) => {
    const allUserPostId = store.getValue("Post.id", {
      where: (postFields) => {
        return postFields.userId === userFields.id
      },
    })

    return allUserPostId.length
  },
})

const postSchema = chaca.schema({
  id: chaca.sequence(),
  userId: chaca.ref("User.id"),
  // this field will throw a cyclic error
  userAge: ({ currentFields }) => {
    const allUser = store.getValue("User")
    const foundUser = allUser.find((u) => u.id === currentFields.userId)

    return foundUser.age
  },
})

const data = chaca.multiGenerate([
  { name: "User", schema: userSchema, documents: 50 },
  { name: "Post", schema: postSchema, documents: 50 },
])
```

The `Post.userAge` field will throw a cyclic error when trying to access the data from the **User** schema when this one has stopped the creation process since it depends on the data from the **Post** schema.

## `getSchemaDocuments`

With this function you can obtain all the documents created up to that moment. **Skipping information from the document currently being created**

```js
store.getSchemaDocuments()
```
